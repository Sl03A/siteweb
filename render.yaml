services:
  # Frontend (Static Site)
  - type: web
    name: slozw-frontend
    env: static
    buildCommand: ""
    staticPublishPath: .
    routes:
      - type: rewrite
        source: /*
        destination: /index_fr.html
      - type: rewrite
        source: /fr/*
        destination: /index_fr.html
      - type: rewrite
        source: /en/*
        destination: /index_en.html
      - type: rewrite
        source: /es/*
        destination: /index_es.html
      - type: rewrite
        source: /de/*
        destination: /index_de.html
      - type: rewrite
        source: /fr/accueil
        destination: /index_fr.html
      - type: rewrite
        source: /en/home
        destination: /index_en.html
      - type: rewrite
        source: /fr/services
        destination: /services_fr.html
      - type: rewrite
        source: /en/services
        destination: /services_en.html
      - type: rewrite
        source: /fr/portfolio
        destination: /portfolio_fr.html
      - type: rewrite
        source: /en/portfolio
        destination: /portfolio_en.html
      - type: rewrite
        source: /fr/boutique
        destination: /boutique_fr.html
      - type: rewrite
        source: /en/shop
        destination: /boutique_en.html
      - type: rewrite
        source: /fr/contact
        destination: /contact_fr.html
      - type: rewrite
        source: /en/contact
        destination: /contact_en.html
      - type: rewrite
        source: /privacy
        destination: /privacy.html
      - type: rewrite
        source: /terms
        destination: /terms.html
    headers:
      - path: /*
        name: Cache-Control
        value: public, max-age=3600
      - path: /*.html
        name: Cache-Control
        value: public, max-age=3600
      - path: /*.css
        name: Cache-Control
        value: public, max-age=86400
      - path: /*.js
        name: Cache-Control
        value: public, max-age=86400
      - path: /translations/*
        name: Cache-Control
        value: public, max-age=86400
      - path: /*
        name: X-Frame-Options
        value: DENY
      - path: /*
        name: X-Content-Type-Options
        value: nosniff
      - path: /*
        name: X-XSS-Protection
        value: 1; mode=block
      - path: /*
        name: Referrer-Policy
        value: strict-origin-when-cross-origin
      - path: /*
        name: Permissions-Policy
        value: "geolocation=(), microphone=(), camera=()"

  # Backend (API PHP)
  - type: web
    name: slozw-backend
    env: php
    buildCommand: ""
    startCommand: "php -S 0.0.0.0:$PORT -t backend"
    rootDir: backend
    envVars:
      - key: PHP_VERSION
        value: 8.2
      - key: DISPLAY_ERRORS
        value: "Off"
      - key: LOG_ERRORS
        value: "On"
      - key: SMTP_HOST
        sync: false
      - key: SMTP_USER
        sync: false
      - key: SMTP_PASS
        sync: false
      - key: ADMIN_EMAIL
        sync: false
      - key: RECAPTCHA_SECRET_KEY
        sync: false
      - key: STRIPE_SECRET_KEY
        sync: false
    routes:
      - type: rewrite
        source: /api/*
        destination: /api.php
      - type: rewrite
        source: /admin
        destination: /admin.php
      - type: rewrite
        source: /login
        destination: /login.php
    headers:
      - path: /*
        name: Access-Control-Allow-Origin
        value: "https://slozw.com"
      - path: /*
        name: Access-Control-Allow-Methods
        value: "POST, GET, OPTIONS"
      - path: /*
        name: Access-Control-Allow-Headers
        value: "Content-Type, X-CSRF-Token"
      - path: /*
        name: X-Frame-Options
        value: DENY
      - path: /*
        name: Content-Security-Policy
        value: "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com;"

  # Base de données (si nécessaire)
  - type: postgres
    name: slozw-database
    plan: free
    ipAllowList: []
    databases:
      - name: slozw_db
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: slozw_db
          property: connectionString

# Variables d'environnement globales
envVars:
  - key: NODE_ENV
    value: production
  - key: APP_ENV
    value: production
  - key: APP_DEBUG
    value: "false"
  - key: APP_URL
    value: https://slozw.com
  - key: TIMEZONE
    value: Europe/Paris

# Cron jobs (tâches planifiées)
crons:
  - name: cleanup-old-data
    schedule: "0 2 * * *"  # Tous les jours à 2h du matin
    command: "php backend/cleanup.php"
  - name: send-newsletter
    schedule: "0 9 * * 1"  # Tous les lundis à 9h
    command: "php backend/newsletter_cron.php"

# Disques persistants (pour les logs et uploads)
disk:
  name: data
  mountPath: /var/data
  sizeGB: 1
